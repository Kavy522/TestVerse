<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Live Exam Monitor - University Exam Portal">
  <title>Live Exam Monitor - University Exam Portal</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/styles.css">
  <link rel="stylesheet" href="../../css/pages/staff/live-monitor.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container">
      <div class="navbar-content">
        <a href="../../index.html" class="navbar-brand">
          <div class="navbar-logo">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
          </div>
          Exam Portal
        </a>
        
        <div class="navbar-menu">
          <a href="dashboard.html" class="navbar-link">Dashboard</a>
          <a href="exams.html" class="navbar-link">Exams</a>
          <a href="students.html" class="navbar-link">Students</a>
          <a href="results.html" class="navbar-link">Results</a>
        </div>
        
        <div class="navbar-user">
          <span class="badge badge-primary">Staff</span>
          <button class="btn btn-ghost btn-sm" onclick="Auth.logout()">Logout</button>
        </div>
      </div>
    </div>
  </nav>
  
  <main class="main-content">
    <div class="container">
      <div class="page-header animate-fadeInUp">
        <div>
          <h1 class="text-3xl font-bold" id="exam-title">Live Exam Monitor</h1>
          <p class="text-muted">Real-time student progress during exam</p>
        </div>
        <div style="display: flex; align-items: center; gap: var(--space-4);">
          <div class="refresh-indicator" id="refresh-indicator">
            <div class="spinner"></div>
            <span>Auto-refreshing...</span>
          </div>
          <div class="live-indicator" id="live-status">OFFLINE</div>
        </div>
      </div>
      
      <!-- Stats -->
      <div class="monitor-stats animate-fadeInUp">
        <div class="monitor-stat-card active">
          <h3 id="active-count">0</h3>
          <p>Currently Taking</p>
        </div>
        <div class="monitor-stat-card">
          <h3 id="completed-count">0</h3>
          <p>Completed</p>
        </div>
        <div class="monitor-stat-card">
          <h3 id="not-started-count">0</h3>
          <p>Not Started</p>
        </div>
        <div class="monitor-stat-card">
          <h3 id="total-questions">0</h3>
          <p>Questions</p>
        </div>
      </div>
      
      <!-- Progress List -->
      <div class="progress-list animate-fadeInUp">
        <div class="progress-list-header">
          <div>Student</div>
          <div>Department</div>
          <div>Progress</div>
          <div>Time Left</div>
          <div>Tab Switches</div>
        </div>
        <div id="progress-container">
          <div class="loading-state" style="padding: 2rem; text-align: center;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p class="text-muted">Loading live data...</p>
          </div>
        </div>
      </div>
      
      <div class="text-center text-muted" style="margin-top: var(--space-6);">
        <a href="exams.html" class="btn btn-ghost">‚Üê Back to Exams</a>
      </div>
    </div>
  </main>
  
  <script src="../../js/config.js"></script>
  <script src="../../js/api.js"></script>
  <script src="../../js/auth.js"></script>
  <script src="../../js/utils.js"></script>
  <script>
    if (!Auth.requireStaff()) {
      throw new Error('Unauthorized');
    }
    
    const examId = new URLSearchParams(window.location.search).get('id');
    let refreshInterval;
    
    if (!examId) {
      Utils.showToast('No exam ID provided', 'error');
      setTimeout(() => window.location.href = 'exams.html', 1500);
    }
    
    // Load live monitor data
    async function loadLiveData() {
      const container = document.getElementById('progress-container');
      const refreshIndicator = document.getElementById('refresh-indicator');
      
      refreshIndicator.style.opacity = '1';
      
      try {
        const data = await API.getExamLiveMonitor(examId);
        
        // Update header
        document.getElementById('exam-title').textContent = data.exam_title || 'Live Exam Monitor';
        
        // Update live status
        const liveStatus = document.getElementById('live-status');
        if (data.is_live) {
          liveStatus.textContent = 'LIVE';
          liveStatus.classList.add('live');
        } else {
          liveStatus.textContent = 'OFFLINE';
          liveStatus.classList.remove('live');
        }
        
        // Update stats
        document.getElementById('active-count').textContent = data.active_count || 0;
        document.getElementById('completed-count').textContent = data.completed_count || 0;
        document.getElementById('not-started-count').textContent = data.not_started_count || 0;
        document.getElementById('total-questions').textContent = data.total_questions || 0;
        
        // Render progress list
        renderProgressList(data.live_attempts || []);
        
      } catch (error) {
        console.error('Error loading live data:', error);
        container.innerHTML = `
          <div class="error-state" style="padding: 2rem; text-align: center;">
            <p class="text-muted">Failed to load live data: ${Utils.escapeHtml(error.message)}</p>
            <button class="btn btn-secondary btn-sm" onclick="loadLiveData()">Retry</button>
          </div>
        `;
      } finally {
        setTimeout(() => refreshIndicator.style.opacity = '0.5', 500);
      }
    }
    
    // Render progress list
    function renderProgressList(attempts) {
      const container = document.getElementById('progress-container');
      
      if (attempts.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted" style="padding: 3rem;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.5;">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <p>No students currently taking this exam</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = attempts.map(attempt => {
        const timeClass = attempt.time_remaining_minutes < 5 ? 'critical' : 
                         attempt.time_remaining_minutes < 15 ? 'warning' : '';
        const tabClass = attempt.tab_switches > 3 ? 'high' : '';
        
        return `
          <div class="progress-item ${attempt.is_struggling ? 'struggling' : ''}">
            <div class="student-info">
              <span class="student-name">${Utils.escapeHtml(attempt.student_name)}</span>
              <span class="student-email">${Utils.escapeHtml(attempt.student_email)}</span>
            </div>
            <div>
              <span class="badge badge-secondary">${Utils.escapeHtml(attempt.department)}</span>
            </div>
            <div class="progress-details">
              <div class="progress-bar-container">
                <div class="progress-bar-fill ${attempt.is_struggling ? 'struggling' : ''}" 
                     style="width: ${attempt.progress_percent}%"></div>
              </div>
              <span class="progress-answers">${attempt.answers_submitted}/${attempt.total_questions} answered (${attempt.progress_percent}%)</span>
            </div>
            <div class="time-remaining ${timeClass}">
              ${Math.floor(attempt.time_remaining_minutes)} min
            </div>
            <div class="tab-switches ${tabClass}">
              ${attempt.tab_switches} ${attempt.tab_switches === 1 ? 'switch' : 'switches'}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Start auto-refresh
    function startAutoRefresh() {
      loadLiveData();
      refreshInterval = setInterval(loadLiveData, 5000); // Refresh every 5 seconds
    }
    
    // Stop on page leave
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) clearInterval(refreshInterval);
    });
    
    // Init
    startAutoRefresh();
  </script>
</body>
</html>
